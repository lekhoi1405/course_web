<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Voucher - Admin - EduLearn</title>
    <link rel="stylesheet" href="../../../resources/css/style.css" />
  </head>

  <body>
    <header class="header">
      <div class="container header-inner no-textAlign">
        <div class="brand">
          <div class="logo">
            <img src="../../../resources/images/logo.svg" alt="EduLearn" />
          </div>
          <div class="name-brand">EduLearn</div>
        </div>

        <div class="actions">
          <div class="user-menu">
            <button class="message-btn" type="button" aria-label="Messages">
              <img
                src="../../../resources/images/userHeader/icon_mess.svg"
                alt="Messages"
                width="20"
                height="20"
              />
            </button>
            <button
              class="notification-btn"
              type="button"
              aria-label="Notifications"
              data-count="0"
            >
              <img
                src="../../../resources/images/userHeader/icon_noti.svg"
                alt="Notifications"
                width="20"
                height="20"
              />
            </button>
            <div class="user-profile">
              <img
                src="../../../resources/images/userHeader/user_avt.svg"
                alt="Admin Avatar"
                class="user-avatar-img"
              />
              <img
                src="../../../resources/images/userHeader/icon_down.svg"
                alt="Dropdown"
                class="user-dropdown-icon"
              />
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="admin-shell">
      <div class="admin-layout">
        <nav class="admin-side-nav">
          <a class="admin-side-link" href="AdminDashboard.html">
            <span class="admin-side-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path
                  d="M4 13h7V4H4v9Zm9 7h7V11h-7v9ZM4 20h7v-5H4v5Zm9-18v7h7V2h-7Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            Dashboard
          </a>

          <a class="admin-side-link" href="AdminAccounts.html">
            <span class="admin-side-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path
                  d="M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3Zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3Zm0 2c-2.33 0-7 1.17-7 3.5V20h14v-3.5C15 14.17 10.33 13 8 13Zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.95 1.97 3.45V20h6v-3.5c0-2.33-4.67-3.5-7-3.5Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            Accounts
          </a>

          <a class="admin-side-link" href="AdminCourses.html">
            <span class="admin-side-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path
                  d="M4 6.5V19c0 .55.45 1 1 1h14v-2H6V6.5h13V4H5c-.55 0-1 .45-1 1v1.5Zm16 1H8c-.55 0-1 .45-1 1v11c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-11c0-.55-.45-1-1-1Zm-1 4h-4v-2h4v2Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            Courses
          </a>

          <!-- âœ… Reports -->
          <a class="admin-side-link" href="AdminReports.html">
            <span class="admin-side-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path
                  d="M3 3h18v2H3V3Zm2 4h14v14H5V7Zm2 2v10h10V9H7Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            Reports
          </a>

          <!-- âœ… Promotions -->
          <a class="admin-side-link" href="AdminPromotions.html">
            <span class="admin-side-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path
                  d="M12 2l3 7h7l-5.5 4 2 7L12 16l-6.5 4 2-7L2 9h7l3-7Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            Promotions
          </a>

          <!-- âœ… (Tuá»³ chá»n) Create Voucher -->

          <a class="admin-side-link" href="#">
            <span class="admin-side-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M4 6h16v12H4V6Zm2 2v8h12V8H6Z" fill="currentColor" />
              </svg>
            </span>
            Content
          </a>

          <a class="admin-side-link" href="#">
            <span class="admin-side-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path
                  d="M19.43 12.98l1.77-1.03-1.5-2.6-2.04.3c-.4-.32-.83-.57-1.3-.75l-.62-1.97h-3l-.62 1.97c-.46.18-.9.43-1.3.75l-2.04-.3-1.5 2.6 1.77 1.03c-.02.16-.03.33-.03.49s.01.33.03.49l-1.77 1.03 1.5 2.6 2.04-.3c.4.32.84.57 1.3.75l.62 1.97h3l.62-1.97c.47-.18.9-.43 1.3-.75l2.04.3 1.5-2.6-1.77-1.03c.02-.16.03-.33.03-.49s-.01-.33-.03-.49ZM14.5 12a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            Settings
          </a>
        </nav>

        <main class="admin-main">
          <div class="admin-page-head">
            <div class="title-wrap">
              <h1>Create New Voucher</h1>
              <p>Create and manage discount vouchers for your platform.</p>
            </div>
          </div>

          <section class="admin-panel">
            <div class="top-actions">
              <a class="admin-btn" href="AdminPromotions.html">Back</a>
              <button class="admin-btn primary" id="btnCreate" type="button">
                Create Voucher
              </button>
            </div>

            <div class="voucher-wrap">
              <!-- LEFT: form -->
              <div class="voucher-card">
                <div class="voucher-section-title">
                  <span class="dot">ðŸ“Œ</span> Basic Information
                </div>

                <div class="voucher-grid">
                  <div class="field">
                    <label for="vName">Voucher Name</label>
                    <input
                      id="vName"
                      type="text"
                      placeholder="e.g. Welcome Discount"
                    />
                  </div>

                  <div class="field">
                    <label>Status</label>
                    <div class="toggle">
                      <input id="vActive" type="checkbox" checked />
                      <span class="helper">Active</span>
                    </div>
                  </div>
                </div>

                <div class="voucher-grid">
                  <div class="field">
                    <label for="vCode">Voucher Code</label>
                    <input
                      id="vCode"
                      type="text"
                      placeholder="e.g. WELCOME10"
                    />
                    <div class="helper">Use uppercase letters & numbers.</div>
                  </div>

                  <div class="field">
                    <label>&nbsp;</label>
                    <button class="admin-btn" id="btnGen" type="button">
                      Generate
                    </button>
                  </div>
                </div>

                <div class="voucher-grid one" style="margin-top: 10px">
                  <div class="field">
                    <label for="vDesc">Description</label>
                    <textarea
                      id="vDesc"
                      placeholder="Optional description..."
                    ></textarea>
                  </div>
                </div>

                <div style="height: 14px"></div>

                <div class="voucher-section-title">
                  <span class="dot">ðŸ’¸</span> Discount Details
                </div>

                <div class="voucher-grid">
                  <div class="field">
                    <label for="vPercent">Discount Percentage</label>
                    <input
                      id="vPercent"
                      type="number"
                      min="1"
                      max="100"
                      value="10"
                    />
                  </div>
                  <div class="field">
                    <label for="vMin">Minimum Purchase</label>
                    <input id="vMin" type="number" min="0" value="0" />
                  </div>
                </div>

                <div class="voucher-grid">
                  <div class="field">
                    <label for="vMaxDiscount">Maximum Discount</label>
                    <input id="vMaxDiscount" type="number" min="0" value="0" />
                    <div class="helper">0 = no cap</div>
                  </div>
                  <div class="field">
                    <label for="vLimit">Maximum Uses</label>
                    <input id="vLimit" type="number" min="1" value="200" />
                  </div>
                </div>

                <div style="height: 14px"></div>

                <div class="voucher-section-title">
                  <span class="dot">ðŸ—“</span> Validity Period
                </div>

                <div class="voucher-grid">
                  <div class="field">
                    <label for="vStart">Start Date</label>
                    <input id="vStart" type="date" />
                  </div>
                  <div class="field">
                    <label for="vEnd">End Date</label>
                    <input id="vEnd" type="date" />
                  </div>
                </div>
              </div>

              <!-- RIGHT: preview -->
              <div
                class="voucher-card"
                style="position: sticky; top: 14px; height: fit-content"
              >
                <div
                  style="
                    display: flex;
                    align-items: flex-start;
                    justify-content: space-between;
                    gap: 10px;
                  "
                >
                  <div>
                    <div class="preview-title" id="pTitle">Voucher Preview</div>
                    <div class="preview-sub" id="pSub">
                      Fill the form to see details.
                    </div>
                  </div>
                </div>

                <div class="preview-row">
                  <span>Code</span>
                  <b id="pCode">â€”</b>
                </div>
                <div class="preview-row">
                  <span>Discount</span>
                  <b id="pDiscount">â€”</b>
                </div>
                <div class="preview-row">
                  <span>Min Purchase</span>
                  <b id="pMin">â€”</b>
                </div>
                <div class="preview-row">
                  <span>Max Discount</span>
                  <b id="pMax">â€”</b>
                </div>
                <div class="preview-row">
                  <span>Usage Limit</span>
                  <b id="pLimit">â€”</b>
                </div>
                <div class="preview-row">
                  <span>Valid Period</span>
                  <b id="pPeriod">â€”</b>
                </div>

                <div
                  style="
                    margin-top: 12px;
                    font-size: 12px;
                    color: #64748b;
                    line-height: 1.45;
                  "
                >
                  Tip: Code should be unique. You can edit it later from
                  Promotions.
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script>
      (function () {
        "use strict";

        const $ = (s, r = document) => r.querySelector(s);
        const lower = (s) => (s || "").toString().toLowerCase();

        // ===== toast (small) =====
        function ensureToastHost() {
          let host = $("#toastHost");
          if (host) return host;
          host = document.createElement("div");
          host.id = "toastHost";
          host.style.position = "fixed";
          host.style.right = "16px";
          host.style.bottom = "16px";
          host.style.display = "grid";
          host.style.gap = "10px";
          host.style.zIndex = "9999";
          document.body.appendChild(host);
          return host;
        }
        function toast({
          title = "Info",
          message = "",
          type = "info",
          ttl = 2200,
        } = {}) {
          const host = ensureToastHost();
          const dot =
            {
              info: "#2563eb",
              success: "#16a34a",
              warning: "#f59e0b",
              danger: "#dc2626",
            }[type] || "#2563eb";

          const item = document.createElement("div");
          item.style.minWidth = "260px";
          item.style.maxWidth = "360px";
          item.style.background = "#fff";
          item.style.border = "1px solid rgba(15,23,42,.12)";
          item.style.borderRadius = "14px";
          item.style.boxShadow = "0 20px 50px rgba(2,6,23,.18)";
          item.style.padding = "12px";
          item.style.opacity = "0";
          item.style.transform = "translateY(8px)";
          item.style.transition = "all .18s ease";
          item.innerHTML = `
            <div style="display:flex; gap:10px; align-items:flex-start;">
              <div style="width:10px; height:10px; border-radius:99px; background:${dot}; margin-top:6px;"></div>
              <div style="flex:1;">
                <div style="font-weight:900; font-size:13px; color:#0f172a;">${title}</div>
                <div style="margin-top:2px; font-size:12px; color:#475569; line-height:1.35;">${message}</div>
              </div>
              <button style="border:none; background:#f1f5f9; width:28px; height:28px; border-radius:10px; cursor:pointer;">âœ•</button>
            </div>
          `;
          const remove = () => {
            item.style.opacity = "0";
            item.style.transform = "translateY(8px)";
            setTimeout(() => item.remove(), 180);
          };
          item.querySelector("button").addEventListener("click", remove);
          host.appendChild(item);
          requestAnimationFrame(() => {
            item.style.opacity = "1";
            item.style.transform = "translateY(0)";
          });
          if (ttl > 0) setTimeout(remove, ttl);
        }

        // ===== store =====
        const STORE_KEY = "admin_vouchers_store";
        function loadStore() {
          try {
            const raw = localStorage.getItem(STORE_KEY);
            return raw ? JSON.parse(raw) : [];
          } catch {
            return [];
          }
        }
        function saveStore(list) {
          try {
            localStorage.setItem(STORE_KEY, JSON.stringify(list));
          } catch {}
        }

        // ===== helpers =====
        function genCode() {
          const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
          let out = "";
          for (let i = 0; i < 9; i++)
            out += alphabet[Math.floor(Math.random() * alphabet.length)];
          return out;
        }
        function fmtMoney(n) {
          const v = Number(n || 0);
          return v <= 0 ? "0" : v.toLocaleString();
        }

        // ===== preview sync =====
        function syncPreview() {
          const name = $("#vName").value.trim();
          const active = $("#vActive").checked;
          const code = $("#vCode").value.trim().toUpperCase();
          const percent = Number($("#vPercent").value || 0);
          const min = Number($("#vMin").value || 0);
          const max = Number($("#vMaxDiscount").value || 0);
          const limit = Number($("#vLimit").value || 0);
          const start = $("#vStart").value;
          const end = $("#vEnd").value;

          $("#pTitle").textContent = name || "Voucher Preview";
          $("#pSub").textContent = name
            ? "Live summary of this voucher."
            : "Fill the form to see details.";
          $("#pCode").textContent = code || "â€”";
          $("#pDiscount").textContent = percent ? `${percent}%` : "â€”";
          $("#pMin").textContent = fmtMoney(min);
          $("#pMax").textContent = max > 0 ? fmtMoney(max) : "No cap";
          $("#pLimit").textContent = limit ? String(limit) : "â€”";
          $("#pPeriod").textContent = start && end ? `${start} â†’ ${end}` : "â€”";

          const badge = $("#pBadge");
          badge.textContent = active ? "Active" : "Inactive";
          badge.classList.toggle("off", !active);
        }

        function validate() {
          const code = $("#vCode").value.trim().toUpperCase();
          const percent = Number($("#vPercent").value || 0);
          const start = $("#vStart").value;
          const end = $("#vEnd").value;

          if (!code) return { ok: false, msg: "Voucher code is required." };
          if (!/^[A-Z0-9]+$/.test(code))
            return {
              ok: false,
              msg: "Code must be uppercase letters & numbers only.",
            };
          if (percent <= 0 || percent > 100)
            return { ok: false, msg: "Discount percentage must be 1..100." };
          if (start && end && start > end)
            return { ok: false, msg: "End date must be after start date." };

          return { ok: true };
        }

        function init() {
          // default dates
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth() + 1).padStart(2, "0");
          const dd = String(today.getDate()).padStart(2, "0");
          $("#vStart").value = `${yyyy}-${mm}-${dd}`;

          // prefill edit if coming from promotions
          const params = new URLSearchParams(window.location.search);
          const editCode = params.get("edit");
          if (editCode) {
            const store = loadStore();
            const found = store.find((x) => x.code === editCode);
            if (found) {
              $("#vName").value = found.name || found.code;
              $("#vCode").value = found.code || "";
              $("#vPercent").value =
                Number((found.discount || "").replace("%", "")) || 10;
              $("#vActive").checked =
                lower(found.status || "active") === "active";
              // period parse best-effort
              const parts = (found.period || "")
                .split("â†’")
                .map((s) => s.trim());
              if (parts[0]) $("#vStart").value = parts[0];
              if (parts[1]) $("#vEnd").value = parts[1];
            }
          }

          // events
          [
            "vName",
            "vActive",
            "vCode",
            "vPercent",
            "vMin",
            "vMaxDiscount",
            "vLimit",
            "vStart",
            "vEnd",
            "vDesc",
          ].forEach((id) => $("#" + id).addEventListener("input", syncPreview));
          $("#vActive").addEventListener("change", syncPreview);

          $("#btnGen").addEventListener("click", () => {
            $("#vCode").value = genCode();
            syncPreview();
          });

          $("#btnCreate").addEventListener("click", () => {
            const v = validate();
            if (!v.ok) {
              toast({
                type: "danger",
                title: "Create Voucher",
                message: v.msg,
              });
              return;
            }

            const store = loadStore();
            const code = $("#vCode").value.trim().toUpperCase();

            // prevent duplicate code
            if (store.some((x) => x.code === code)) {
              toast({
                type: "danger",
                title: "Create Voucher",
                message: `Code "${code}" already exists.`,
              });
              return;
            }

            const payload = {
              code,
              name: $("#vName").value.trim() || code,
              discount: `${Number($("#vPercent").value || 0)}%`,
              usage: `0 / ${Number($("#vLimit").value || 0)}`,
              period:
                $("#vStart").value && $("#vEnd").value
                  ? `${$("#vStart").value} â†’ ${$("#vEnd").value}`
                  : "â€”",
              status: $("#vActive").checked ? "active" : "expired",
            };

            store.unshift(payload);
            saveStore(store);

            toast({
              type: "success",
              title: "Create Voucher",
              message: `Created "${code}".`,
            });
            setTimeout(
              () => (window.location.href = "AdminPromotions.html"),
              400
            );
          });

          syncPreview();
        }

        document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
  </body>
</html>
